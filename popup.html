<style>
body { overflow-x:hidden; }
#content {
}
a { display:block; padding-left:5px; height:24px; line-height:24px; white-space:nowrap; color:black; text-decoration:none; }
a.active, a.active:hover { 
  background-color:lightgreen;
}
a span { margin-left:5px; font-size:12px; vertical-align:middle; line-height:24px; height:24px; }
a img { vertical-align:middle; height:16px; width:16px; padding-top:4px; padding-bottom:4px; }
a:hover { background-color:#dfe6f6; } 
</style>
<!-- <script src="jquery-1.3.2.min.js"></script> -->
<script>
  var tabInfo = {
    tabList: new Array,
    tabCurrent: new Object
  }

  Array.prototype.each = function (fn) {
    for(var i=0;i<this.length;i++){ 
      fn(this[i]);
    }
  }
  String.prototype.truncate = function (maxChars) {
    if (typeof maxChars === 'undefined')
      var maxChars = 64;
    if (this && this.length > maxChars) return this.substring(0, maxChars) + '...'; else return this;
  }
  Array.prototype.findByTabId = function (tabId) {
    for(var i=0;i<this.length;i++) {
      if (this[i].id == tabId)
        return this[i];
    }
  }

  function makeEntry(tab) {
    var text = document.createElement('span');
    var link = document.createElement('a');
    var favIcon = new Image();

    var title = tab.title.truncate();
    var url = tab.url;

    favIcon.src = tab.favIconUrl;
    favIcon.alt = 'favIcon'

    text.textContent = title;

    link.setAttribute('href', url);
    link.setAttribute('id', tab.id)

    link.appendChild(favIcon);
    link.appendChild(text);

    if (tab.selected) link.className = 'active';

    return link;
  }

  function setActiveLink() {
    console.log(tabInfo.tabCurrent.url);
    var box = document.getElementById('content');
    var len = box.childNodes.length;


    //remove all classNames where active
    for(var i=0;i<len;i++) {
      if (box.childNodes[i].localName == 'a') {
        var link = box.childNodes[i];
        if (link.className.match('active')) link.className = '';
      }
    }

    // add active className for the appropriate link
    for(var i=0;i<len;i++) {
      if (box.childNodes[i].localName == 'a') {
      var link = box.childNodes[i];
      var linkId = link.getAttribute('id');
      if ( linkId == tabInfo.tabCurrent.id ) link.className += ' active';
      }
    }
  }
  function init() {
    var tabs = tabInfo.tabList;

    var box = document.getElementById('content');

    for(var i=0;i<tabs.length;i++) {
      if (tabs[i].selected) tabInfo.tabCurrent = tabs[i];

      if (tabs[i].status == 'complete') {
        var link = makeEntry(tabs[i]);
        box.appendChild(link);

        link.onclick = function (e) {
          e.preventDefault(); 
          var tabId = parseInt(this.getAttribute('id'));
          chrome.tabs.update(tabId, {selected:true}, function cb(tab){
            tabInfo.tabCurrent = tab;
            setActiveLink();
          })
        }
      }
    }
  
  }
  /* populates window.tabInfo.tabList with the current tab list,
     and sets window.tabInfo.tabCurrent to the current tab */

  chrome.tabs.getAllInWindow(null, function f(tabs) { tabInfo.tabList = tabs; init(); });
</script>
<body>
  <div id="content">
  </div>
</body>

